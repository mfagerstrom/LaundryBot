-- Recreate LaundryBot schema from scratch.
-- This script replaces all LaundryBot tables and seeds a single laundry status row.

CREATE TABLE LAUNDRY_USERS (
  DISCORD_USER_ID VARCHAR2(32) PRIMARY KEY,
  DISPLAY_NAME VARCHAR2(100) NOT NULL,
  IS_ACTIVE NUMBER(1) DEFAULT 1 NOT NULL,
  CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

CREATE TABLE LAUNDRY_STATUS (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  MACHINE_TYPE VARCHAR2(10) NOT NULL,
  STATUS VARCHAR2(20) NOT NULL,
  CURRENT_USER_ID VARCHAR2(32),
  CURRENT_USER_NAME VARCHAR2(100),
  STARTED_AT TIMESTAMP,
  EXPECTED_DONE_AT TIMESTAMP,
  UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
  UPDATED_BY_USER_ID VARCHAR2(32),
  UPDATED_BY_NAME VARCHAR2(100),
  NOTES VARCHAR2(4000),
  CONSTRAINT LAUNDRY_STATUS_MACHINE_TYPE_UQ UNIQUE (MACHINE_TYPE),
  CONSTRAINT LAUNDRY_STATUS_MACHINE_TYPE_CK CHECK (
    MACHINE_TYPE IN ('laundry')
  ),
  CONSTRAINT LAUNDRY_STATUS_STATUS_CK CHECK (
    STATUS IN ('available', 'in_use', 'maintenance')
  ),
  CONSTRAINT LAUNDRY_STATUS_CURRENT_USER_FK FOREIGN KEY (CURRENT_USER_ID)
    REFERENCES LAUNDRY_USERS (DISCORD_USER_ID),
  CONSTRAINT LAUNDRY_STATUS_UPDATED_BY_FK FOREIGN KEY (UPDATED_BY_USER_ID)
    REFERENCES LAUNDRY_USERS (DISCORD_USER_ID)
);

CREATE TABLE LAUNDRY_STATUS_HISTORY (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  MACHINE_TYPE VARCHAR2(10) NOT NULL,
  STATUS VARCHAR2(20) NOT NULL,
  USER_ID VARCHAR2(32),
  USER_NAME VARCHAR2(100),
  STARTED_AT TIMESTAMP,
  ENDED_AT TIMESTAMP,
  UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
  UPDATED_BY_USER_ID VARCHAR2(32),
  UPDATED_BY_NAME VARCHAR2(100),
  NOTES VARCHAR2(4000),
  CONSTRAINT LAUNDRY_STATUS_HIST_MACHINE_CK CHECK (
    MACHINE_TYPE IN ('laundry')
  ),
  CONSTRAINT LAUNDRY_STATUS_HIST_STATUS_CK CHECK (
    STATUS IN ('available', 'in_use', 'maintenance')
  ),
  CONSTRAINT LAUNDRY_STATUS_HIST_USER_FK FOREIGN KEY (USER_ID)
    REFERENCES LAUNDRY_USERS (DISCORD_USER_ID),
  CONSTRAINT LAUNDRY_STATUS_HIST_UPDATED_BY_FK FOREIGN KEY (UPDATED_BY_USER_ID)
    REFERENCES LAUNDRY_USERS (DISCORD_USER_ID)
);

CREATE INDEX LAUNDRY_STATUS_HISTORY_MACHINE_IDX
  ON LAUNDRY_STATUS_HISTORY (MACHINE_TYPE);

CREATE INDEX LAUNDRY_STATUS_HISTORY_UPDATED_IDX
  ON LAUNDRY_STATUS_HISTORY (UPDATED_AT);

CREATE TABLE LAUNDRY_HELP_REQUESTS (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USER_ID VARCHAR2(32) NOT NULL,
  USER_NAME VARCHAR2(100) NOT NULL,
  REQUEST_TYPE VARCHAR2(100) NOT NULL,
  STATUS VARCHAR2(20) DEFAULT 'active' NOT NULL,
  CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
  RESOLVED_AT TIMESTAMP,
  CONSTRAINT LAUNDRY_HELP_REQUESTS_STATUS_CK CHECK (
    STATUS IN ('active', 'resolved')
  )
);

CREATE INDEX LAUNDRY_HELP_REQUESTS_STATUS_IDX
  ON LAUNDRY_HELP_REQUESTS (STATUS, CREATED_AT);

CREATE TABLE LAUNDRY_NOTIFICATIONS (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  CHANNEL_ID VARCHAR2(32) NOT NULL,
  MESSAGE VARCHAR2(4000) NOT NULL,
  DUE_AT TIMESTAMP NOT NULL,
  SENT_AT TIMESTAMP,
  STATUS VARCHAR2(20) DEFAULT 'pending' NOT NULL,
  CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
  CREATED_BY_USER_ID VARCHAR2(32),
  CREATED_BY_NAME VARCHAR2(100),
  NOTES VARCHAR2(4000),
  CONSTRAINT LAUNDRY_NOTIFICATIONS_STATUS_CK CHECK (
    STATUS IN ('pending', 'sent', 'failed')
  )
);

CREATE INDEX LAUNDRY_NOTIFICATIONS_DUE_IDX
  ON LAUNDRY_NOTIFICATIONS (DUE_AT, STATUS);

INSERT INTO LAUNDRY_USERS (DISCORD_USER_ID, DISPLAY_NAME)
VALUES ('715692681883418755', 'Leah');

INSERT INTO LAUNDRY_USERS (DISCORD_USER_ID, DISPLAY_NAME)
VALUES ('191938640413327360', 'Mike');

INSERT INTO LAUNDRY_USERS (DISCORD_USER_ID, DISPLAY_NAME)
VALUES ('715699384687525950', 'Eve');

INSERT INTO LAUNDRY_STATUS (
  MACHINE_TYPE,
  STATUS,
  NOTES
) VALUES ('laundry', 'available', 'Seeded initial state.');

COMMIT;
